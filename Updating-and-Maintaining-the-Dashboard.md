## Table of Contents <a name="table"></a>
1. [Description](#description) 
2. [Input Files](#input)
3. [Outer Dashboard Structure](#outer)
4. [Ecosystem Module](#ecosystem)
    1. [Ecosystem graph model subsection](#ecograph)
    2. [Platforms and PlatformTypes subsections](#platforms)
5. [Restaurants Module](#restaurants)
6. [Social Module](#social)
7. [Potential Improvements](#improvements)

## Description <a name="description"></a>

The FHRSOP dashboard is based on [Rstudio' Shiny](https://shiny.rstudio.com) with [Shinydashboard](https://rstudio.github.io/shinydashboard/index.html) and uses several files as inputs.

Most of these inputs are part of the git repository so they are present by default, with the notable exception being the SQLite database that is generated by the preceding pipeline. This page will give a detailed overview of the dashboard's inner workings to facilitate its maintenance or future updates.

Briefly, the dashboard's code consists out of:
1. _global.R_ -- Initialization of packages, functions and points to location of inputs
2. _ui.R_ -- Outer structure of the dashboard, that calls ui-modules
3. _server.R_ -- Outer Shiny server that initializes the db and calls server-modules
4. _*.md_ files -- Descriptive texts that are shown at the top of each page
5. 3 shiny [modules](https://shiny.rstudio.com/articles/modules.html) located in the `R/` subdirectory -- 3 ui+server modules, one for each of the main three sections 

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

## Input Files <a name="input"></a>

All input files are listed at the top of _global.R_:

- IN_DB: [SQLite database](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Database) created by the FHRSOP pipelineand the source of most of the data
- IN_ECO_NODES: The [nodes](https://github.com/S2DSLondon/Aug20_FSA/wiki/Preparing-the-Food-Ecosystem,-Food-Platform-Typology,-and-Food-Platforms) of the ecosystem graphic model nodes, with additional columns for the different representations of the model
- IN_ECO_EDGES: Same as above but for the [edges](https://github.com/S2DSLondon/Aug20_FSA/wiki/Preparing-the-Food-Ecosystem,-Food-Platform-Typology,-and-Food-Platforms)
- IN_ECO_SPECS: A [specifications](https://github.com/S2DSLondon/Aug20_FSA/wiki/Preparing-the-Food-Ecosystem,-Food-Platform-Typology,-and-Food-Platforms) table of the different representations of the model
- IN_FOOD_DICT: A dictionary of words that are food-related to highlight in the [wordcloud](https://github.com/S2DSLondon/Aug20_FSA/wiki/Analysing-the-Social-Platforms-Data-with-NLP)
- IN_OMITTED_WORDS: A list of manually curated words to exclude from the [wordcloud](https://github.com/S2DSLondon/Aug20_FSA/wiki/Analysing-the-Social-Platforms-Data-with-NLP)
- Markdown files with the descriptive texts for each page
- Shiny modules located in `R/` (automatically loaded)

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

## Outer Dashboard Structure <a name="outer"></a>

The Shiny dashboard's made code is in all of its modules, this makes the 'outer' structure relatively uncluttered:
* The dashboard's ui consists out of a top bar with a title, a navigation panel on the left, and a main panel on the right.
* The navigation panel also holds hidden panels with the input sliders which hide and show depending on which page is opened.
* The server file does three things besides load the module:
> * It opens the SQLite database.
> * It reads and splits the platforms into 'restaurants' and 'social'. 
> * It passes on the modules whether a page has been opened.
* The splitting of the platforms is currently based on the following: `IF a platform has platformtype that contains the word "Social" in its businessmodeltype then it set as 'social' else it is set as 'restaurant'`.
* Currently, this splits Facebook into the former and Deliveroo and Kukd into the latter.
* The page opening [reactives](https://shiny.rstudio.com/tutorial/written-tutorial/lesson6/) that are passed to the modules are so each module only starts loading its data and populating the input options once a corresponding page has been opened.
* Potentially, there is a more elegant way to solve this, but we have not figured this out.

_Small note about modules and namespaces: ui and server modules share an `id` which defines its namespace. Inside a module, the ui and server only have access to the objects within that namespace unless it is explicitly passed on to the module._

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

## Ecosystem Module ('id = ecosystem') <a name="ecosystem"></a>

This module consists out of 5 ui modules and 1 server module:
- `ecosystemModuleUIcontrolSchematic` -- Control ui for the graph model page
- `ecosystemModuleUIcontrolLists` -- Control ui for the platforms / platformTypes pages
- `ecosystemModuleUIpageEcosystem` -- Main page of ecosystem graphical model
- `ecosystemModuleUIpageTypology` -- Main page of platformType
- `ecosystemModuleUIpagePlatforms` -- Main page of platforms
- `ecosystemModuleServer` -- The backend for all of the above

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

### Ecosystem graph model subsection <a name="ecograph"></a>

The graph of the ecosystem in created by [visNetwork](https://datastorm-open.github.io/visNetwork/) and is encoded in the input files listed above.
* It is initialised only once by `renderVisNetwork()` as an invisible network and then updated depending on the input by `visNetworkProxy()`.
* The input selected is defined as a row in the 'specs' table, which defines the column names to look at in the nodes/edges tables.
* The code then updates colours and other specifications depending on the selected columns.
* The input `current_node_id` is set by a javascript command in a `visEvents()` function and, for this, the namespace has to be manually prepended:
```
 Shiny.setInputValue('ecosystem-current_node_id', NaN, {priority: 'event'});
```
* When a node has been selected, two tables appear below with subsets of the platforms: (`output$ecosysPlatforms`) and platformtypes list (`output$ecosysTypologies`) - plus buttons.
* Clicking the buttons sets the selected node as a filter in their respective pages and switches to that page (_note that, in order to do this, it needs access `input$tabs`, which is outside of this module namespace so the session id of the parent is passed on to the module_). 

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

### Platforms and PlatformTypes subsections <a name="platforms"></a>

The platforms and platformTypes lists share the same set of filters so they are updated simultaneously:
* There are two sets of filters: 1) by platform typology and 2) by ecosystem node. 
* When one of these filter sets is selected, the other is ignored, which is why both lists have two entries in their main reactive `r.platlist.lists`. * Most of the server code for this session is to apply the filters and clean up the data.
* Additionally, the platformlist shows fewer columns but has an added `moreInfo` button which is created directly with some javascript:
```
onclick = sprintf('Shiny.setInputValue(\"%s-moreInfoPlatform\",  this.id, {priority: \"event\"})', id)
```
* Again, we have to manually prepend the namespace (`id`) in order to correctly map the buttons to `input$moreinfoPlatform`. 
* Clicking this button pops up a modal with additional information for that platform.
* Because the [DataTable](https://shiny.rstudio.com/articles/datatables.html) itself does not contain the information shown under `moreInfo`, we manually added a .csv download button (for other tables we could simply utilize DataTables 'buttons' extension).

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

## Restaurants Module ('id = restaurants', 'submodule_id = restaurantsPlots') <a name="restaurants"></a>

This module consists out of 2 ui modules, 1 server module and a submodule:
* `restaurantModuleUIcontrol` -- Control ui 
* `restaurantModuleUIpage` -- Main page of the restaurants page
* `restaurantModuleServer` -- Server for the restaurants page
* Plots submodule -- submodule that takes care of the plots at top of the page
> * `restaurantModuleUIpagePlots` -- ui with the plots
> * `restaurantModuleServerPlots` -- server of the plots

_Note that submodules do not by default have access to its parents' namespace (in the same way a module does not have access to the main server's namespace)._ 

_Also note that calling the submodule id "restaurantsPlots" in the ui has to be wrapped in:_
```
ns()` (`,restaurantModuleUIpagePlots(ns("restaurantsPlots"))`)
```
* The `restaurantModuleServer` applies the filters selected on the left side in a series of reactives.
* Each filter creates a new reactive, so not all filters have to be reapplied when a single filter parameter changes.
* _Note that `RatingDate` of "1901-01-01" is changed to `NA`._
* The plots and infoboxes in `restaurantModuleServerPlots` are straightforward except that for `RatingDates` older than 5 years are set to 5 years old (in the plot only, not in the median line). 
* The infoboxes in `restaurantModuleUIpagePlots` are surrounded by a mess of `div()`s in order to scale nicely with the page size, this can definitely be improved.

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

## Social Module ('id = social') <a name="social"></a>

This module consists out of 2 ui modules and 1 server module:
* `socialModuleUIcontrol` -- Control ui 
* `socialModuleUIpage` -- Main page of the social page
* `socialModuleServer` -- Server for the social page

Dataset selection takes place on the left side, while the two plots (wordcloud and frequencyplot) are right next to additional plot inputs. The server is quite straightforward: The data is subsetted, cleaned, and fed into the wordloud and frequencyplot (see [Analysing the Social Platforms Data with NLP ](https://github.com/S2DSLondon/Aug20_FSA/wiki/Analysing-the-Social-Platforms-Data-with-NLP) for further details).

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)

## Potential Improvements <a name="improvements"></a>

* Add CSS into a separate css file.
* Optimize db use. `collect()` is called early for some summarising functions that are not possible in SQL queries (to our best abilities). Ideally, `collect()` would only be called at the very end when showing the lists in order to minimize memory usage. Potentially, these changes have to be implemented in _SQLiteCreator.py_.
* Add location information in restaurants and social tabs, with interactive maps for example.
* Add functionality for comparing two platforms under restaurants page.
* Alternative package for wordcloud (we have been unable to control its size)
* Add input free text for removing words from wordcloud.
* Ecosystem node names instead of numbers.
* More sophisticated NLP in the Social tab.
* Example 'cards' of some the social listings in the social tab (list view would make the table too wide).

[Go to Top](https://github.com/S2DSLondon/Aug20_FSA/wiki/Updating-and-Maintaining-the-Dashboard#table)